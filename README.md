## Basics
This repository hosts code for reproducing numerical experiments presented in the book chapter ''Gas Mixtures on Networks: Modeling, Simulation and Optimization'' written as part of the DFG project SFB Transregio 154: Modeling, Simulation and Optimization of Gas Networks. 

Chapter authors: Pascal Boerner, Jan Giesselmann, Varun M. Kumar, Marc E. Pfetsch, Michael Thiele, Tabea Tscherpel. 

A preprint of the chapter is available [here.](https://opus4.kobv.de/opus4-trr154/frontdoor/index/index/searchtype/all/docId/623/start/0/rows/10)

This README file is organised as follows:
- Quick start guide
    - Dependencies
    - Structure of `numerical_experiments` subfolder
    - Running a numerical experiment

- Code files: discusses each of the `.py` files in the main directory, summarises their function, parameter choices, requirements, and in which section of the text the results are used. Organized by:
    - Computational code files
    - Image code files

- Data: summarises where data required for the computations can be found. Organized by:
    - Network physical data
    - Network algebraic solution data
    - Pressure law data

- At the end, for each section, we list the Python programs used to achieve the results in the text. The runs can be replicated using the scripts in the `numerical_experiments` subfolder, discussed immediately below.  

**Note:** The code for the experiment in Section 1.6.2 (Optimization) is not hosted here but is available as part of the repositories [TRR154/GasA01](https://github.com/TRR154/GasA01) and [TRR154/StationaryMixingData](https://github.com/TRR154/StationaryMixingData). 

## Quick start guide
Here we discuss how to get to running the numerical experiments as quickly as possible. 

### Running numerical experiments
#### Dependencies
The code only requires packages available via pip. To install all required dependencies, navigate to the main directory and run
```
pip install -r requirements.txt 
```

- Note: We strongly recommend installation in a **virtual machine**, so as not to disturb the modules on your machine's core Python installation. For more on this, see the `venv` Python module. 

#### Structure of the `numerical_experiments` folder
Contains several subfolders, each named after a section of the chapter. In the folder for each section there are
- **Script/s:** Python files which can be run to produce the output of the corresponding experiment. Each script begins with a description which includes:
    - Which section the script corresponds to
    - What the experiment investigates
    - The command required to run the experiment **(see below)**
    - **Each script contains the location of the actual output (solutions, plots, etc) that results from running it.** In general
        - Solutions computed by running the scripts are found under `save_solutions/solutions`.
        - Plots generated by running the scripts are found under `graphics`.
        - In the case of Section 1.6.7, the convergence rates are printed to the terminal. 

    In most cases the scripts are blocks which compute solutions and then plot results all at once.
    - EXCEPTION Section 1.5.4: Scripts for computing solutions and plotting results are separate. 
    - EXCEPTION Section 1.6.7, for one- and two-velocity experiments: Separate scripts for
        - Computing solutions
            
            **Warning:** each of these takes approximately **one week** to run on machines with the following parameters

                Model name:           Intel(R) Xeon(R) CPU E5-4650 0 @ 2.70GHz
                CPU family:           6
                Model:                45

        - Computing linear interpolant values

            **Warning:** each of these takes approximately **two days** to run on a machine with the same parameters as above.

        - Computing the norms required for the convergence study.
        - **Note:** The following files are compressed as `.zip` archives in order to comply with GitHub maximum file size requirements, and **must be uncompressed before runnning the 2v scripts for this section**:
          
          - `save_solution/solutions/network_2v_f_1_timedep/compstudy/` (all files)
          - `save_solution/solutions/network_2v_f_1_timedep/massflowinflow/2v_gaslib40_removed_edit_dx_87.79149519890261_dt_42.10526315789474_T_14400_SCENARIO_time_dep_pressure_speed_of_sound_algebraic_1.0.zip`
    

- **`output` folders:** These folders contain **pre-made copies** of the output of each script, i.e. the results presented in each section. In most cases this is organised into the following subfolders:
    - `solutions`: These contain numerical solutions stored as arrays in the Pickle format. Extension: `.pkl`.
    - `plots`: These contain copies of the plots which are presented in each section. 

    Note that the `output` folder for Section 1.6.7 does not store copies of the solutions and interpolant values, since in this case these take up ~2Gb of space. The locations of the numerical solutions and the interpolant values are noted in each of the respective scripts in this folder. 

- An empty `__init__.py` file: this is necessary for running the scripts as modules. See **Running a numerical experiment** below. 
   


##### Example

`section_1_5_3` contains:
- `script_section_1_5_3.py`: script for numerical experiment
- `output`: folder, containing subfolders:
    - `solutions`
    - `plots`
- `__init__.py`


#### Running a numerical experiment
Once the dependencies have been installed, the scripts can be run. Note that the scripts are required to be run as **Python modules** from the **main directory**. 

##### Example
To run the script for the numerical experiment in Section 1.3, **navigate to the main directory** and run
```
python -m numerical_experiments.section_1_3.script_section_1_3
```







## Code files (`.py`)

### Computation code files
These files are used to define functions, run computations, save/load solutions, and make plots of solutions. They are located in the main directory.

**Note:** We only list internal dependencies between parts of our code. External required Python modules can be found in `requirements.txt`.


#### `pressure_laws_comparison.py` 
Computes the relative difference of other pressure laws from GERG-08 in the range of validity and plots the results.
- Defines a callable function for the total pressure as a function of the densities for the following pressure laws (variable names in code are in brackets), see method `pressure_law_mixtures()` or `fit_gerg_simple()`: 
    - ideal gas law (`speed_of_sound`),
    - virial expansion (`virial_expansion`),
    - mixed virial expansion (`virial_expansion_mix`),
    - GERG-08 (`gerg`),
    - polynomial fitted to GERG-08 (`gerg-fit`) for different polynomial degrees.

    In the case of simple pressure laws, can instead return the partial pressures via setting the `return_partial_pressures` parameter to `True`. 
- Includes certain physical and other data such as the universal gas constant, molar masses of methane and hydrogen, and coefficients for the virial and mixed virial expansions. 
- Requires: none
- Results:
    - Sec 1.3: Comparison of pressure laws 

#### `one_pipe_setinflow.py`  
Defines a routine to convert a tuple of mass flow and pressure values to a tuple of density and velocity values for each of the above pressure laws. Used for calculating boundary data in other programs. 
- Requires:
    - `pressure_laws_comparison`: pressure law functions, fitting function for GERG-08

#### `transform_xml_file.py`
Modifies the `.net` network files (see below) in the following ways:
1. Removes compressors by inserting new nodes
2. Accesses the algebraic solution (`.lsf` file) corresponding to the network and sets network pipe directions according to the flow directions of the algebraic solution.
- Requires: Network architecture (`.net`) and algebraic solution (`.lsf`) files


#### `network_1v_timedep_dxdtform_massflowinflow.py` 
Computes stationary and instationary solutions of the 1v model discretized using the box scheme. Can save, load and make plots of solutions. Sets TOTAL MASS FLOW and MIXING RATIO as boundary data on INFLOW nodes and TOTAL PRESSURE on OUTFLOW nodes.  
- Defines `Network_1v_time` class. This includes functions for:
    - Reading in the network and solution files and converting these into Python structures. In particular, the network information is stored as a Python `dict`. 
    - Precomputing the pressure law so that this is available as a function. 
    - Computing additional physical parameters such as the pipe friction.
    - Converting the network into a space-time grid of points.
    - Solving the box scheme discretisation of the 1v model via Newton's method.
    - Storing and loading solutions.
    - Plotting solutions.
- Parameters:
    - Network: choice of network structure. Variable: `file_network`. Options: `one_pipe` (single pipe), `3mixT` (3-star/Y-shape), `one_cycle`   (simple network with one cycle), `gaslib40_edit` (GasLib40, no compressors), `gaslib40_removed_edit` (GasLib40-3, no compressors). 
    - Algebraic solution: choice of algebraic/Weymouth equation solution file, must correspond to network choice and a choice of data. Variable: `file_data`. Options: `one_pipe` (single pipe), `3mix_temp_0` (3-star/Y-shape), `one_cycle`   (simple network with one cycle), `gaslib40_edit` (GasLib40, no compressors), `gaslib40_removed_edit` (GasLib40-3, no compressors). 
    - Pressure law. Variable: `model`. Options: the laws defined in `pressure_law_comparisons.py`. 
    - Stationary or instationary: determines the time horizon (stationary computed as long time limits) and selects a specification of compatible initial and boundary data. Variable: `scenario`. Options: `gaslib40_stationary` (stationary), `time_dep` (instationary). **Note: The specification of initial and boundary data is discussed in Sections 1.5 (single pipe) and 1.6 (networks) in the chapter.**
    - $\Delta x$ and $\Delta t$: space and time discretisation parameters. Selected as candidate values, true values determined by rounding such that we have integer numbers of space and time entries. Variables: `candidate_dx`, `candidate_dt`. 
    - Multiplicative coefficient for the $\partial_x(\rho v^2)$-term: Set to 1 by default as required by most of our computations, but can be set to 0 to validate the algebraic Weymouth solution. Variable: `algebraic`. 
    - Numerical tolerance for computational purposes, set to `1e-7` by default. Variable: `tol`.  
- Requires: 
    - `pressure_laws_comparison`: pressure law functions, fitting function for GERG-08
    - `one_pipe_setinflow`: boundary values for 1v model (mass flow, pressure + pressure law -> densities, velocity)
- Results:
    - Sec 1.6.6: Solution plots on Gaslib40-3. Fig. 1.11 and 1.15 

#### `network_1v_timedep_dxdtform_pressureinflow.py` 
Same as `network_1v_timedep_dxdtform_massflowinflow.py`, but with TOTAL PRESSURE and MIXING RATIO on INFLOW nodes and TOTAL MASS FLOW on OUTFLOW nodes.  

#### `network_2v_timedep_dxdtform_massflowinflow.py` 
Computes stationary and instationary solutions of the 2v model discretized using the box scheme. Can save, load and make plots of solutions. Sets PARTIAL MASS FLOWS as boundary data on INFLOW nodes and PARTIAL PRESSURES on OUTFLOW nodes.  
- Defines: `Network_2v_time` class. This includes functions for:
    - Reading in the network and solution files and converting these into Python structures. In particular, the network information is stored as a Python `dict`. 
    - Precomputing the pressure law so that this is available as a function. 
    - Computing additional physical parameters such as the pipe friction.
    - Converting the network into a space-time grid of points.
    - Solving the box scheme discretisation of the 2v model via Newton's method.
    - Storing and loading solutions.
    - Plotting solutions.
- Choices:
    - Network (as in `network_1v_timedep_dxdtform_massflowinflow.py`).
    - Weymouth/algebraic solution for given network (as in `network_1v_timedep_dxdtform_massflowinflow.py`). 
    - Pressure law. Variable: `model` Options: all __simple__ pressure laws defined in `pressure_law_comparisons.py`.
    - Stationary or instationary: determines the time horizon (stationary computed as long time limits) and selects a specification of compatible initial and boundary data. Variable: `scenario`. Options: `gaslib11_stationary_1v` (stationary), `time_dep` (instationary). **Note: The specification of initial and boundary data is discussed in Sections 1.5 (single pipe) and 1.6 (networks) in the chapter.**
    - $\Delta x$ and $\Delta t$ (as in `network_1v_timedep_dxdtform_massflowinflow.py`).
    - Multiplicative coefficient for the $\partial_x(\rho_i v_i^2)$-terms for $i \in \{1,2\}$: Set to 1 by default. Variable: `algebraic`. 
    - Numerical tolerance for computational purposes, set to `1. Variable: `tol`.  
    - Inner friction parameter: quantifies the friction between the constituents (methane and hydrogen) under the assumption that they have different velocities. Variable: `f`. 
- Requires: 
    - `pressure_laws_comparison`: pressure law functions, fitting function for GERG-08
    - `one_pipe_setinflow`: boundary values for 1v model (mass flow, pressure + pressure law -> densities, velocity)
    - `network_1v_timedep_dxdtform_massinflow`: network boundary conditions given from 1v model
- Results:
    - Sec 1.6.6: Solution plots on Gaslib40-3. Fig. 1.16, Fig. 1.15 

#### `network_2v_timedep_dxdtform_pressureinflow.py` 
Same as `network_2v_timedep_dxdtform_massflowinflow.py`, but with PARTIAL PRESSURES on INFLOW nodes and PARTIAL MASS FLOWS on OUTFLOW nodes.  

#### `onepipe_instationary.py` 
Computes instationary solutions of the 2v model discretized using the box scheme on a single pipe.
- Initial and boundary data are hard-coded. **Note: The specification of initial and boundary data is discussed in Section 1.5.4 in the chapter.**
- Requires:
    - `network_2v_timedep_dxdtform_massflowinflow.py`: the `Network_2v_time` class, in order to read in network data, compute the pressure law and pipe friction, compute $\Delta x$ and $\Delta t$ and convert the pipe into a space-time grid of points. 
- Results:
    - Sec 1.5.4: Plots of instationary solutions of the 2v model on a single pipe for various levels of the inner friction. 

#### `linearinterpolants.py`
Computes the linear interpolant of a coarse numerical solution using the space time grid of a pre-selected finer numerical solution. Works for 1v and 2v solutions. 
- Requires: solutions computed by
    - `network_1v_timedep_dxdtform_massflowinflow.py`
    - `network_2v_timedep_dxdtform_massflowinflow.py`
- Results:
    - Sec 1.6.7: Convergence rates for the box scheme as applied to the 1v and 2v models.





### Image code files
These code files load previously computed solutions and generate additional plots, e.g. differences of 1v and 2v solutions. They are located in the main directory. 

#### `network_1v_images.py`
Creates images comparing stationary solutions of the 1v model on the GasLib40-3 network:
1. For various pressure laws.
2. For the ideal gas law with and without the nonlinear term $\partial_x(\rho v^2)$.

- Requires: solutions computed by `network_1v_timedep_dxdtform_massflowinflow`
- Results:
    - Sec 1.6.4: Comparison of pressure laws
    - Sec 1.6.5: Validation of optimization

#### `diff_1v_2v_one_pipe_massflowinflow.py`
Creates images comparing stationary 1v and 2v solutions on a single pipe where we set MASS FLOW/S on the INFLOW and PRESSURE/S on the OUTFLOW. For 1v, we set MIXTURE RATIO on the INFLOW. 
- Requires: solutions computed by:
    - `network_1v_timedep_dxdtform_massflowinflow`
    - `network_2v_timedep_dxdtform_massflowinflow`
- Results:
    - Sec 1.5.3: Single pipe stationary computations 1v vs 2v


#### `diff_1v_2v_one_pipe_pressureinflow.py`
Creates images comparing stationary 1v and 2v solutions on a single pipe where we set PRESSURE/S on the INFLOW and MASS FLOW/S on the OUTFLOW. For 1v, we set MIXTURE RATIO on the INFLOW. 
- Requires: solutions computed by 
    - `network_1v_timedep_dxdtform_pressureinflow`
    - `network_2v_timedep_dxdtform_pressureinflow`
- Results:
    - Sec 1.5.3: Single pipe stationary computations 1v vs 2v with mass inflow bc

#### `diff_1v_2v_network_massflowinflow.py`
Creates images comparing stationary 1v and 2v solutions on each pipe of GasLib40-3 where we set MASS FLOW/S on the INFLOW and PRESSURE/S on the OUTFLOW. For 1v, we set MIXTURE RATIO on the INFLOW. 
- Requires: solutions computed by:
    - `network_1v_timedep_dxdtform_massflowinflow`
    - `network_2v_timedep_dxdtform_massflowinflow`
- Results:
    - Sec 1.6.6: Gaslib40-3 stationary computations 1v vs 2v with mass inflow bc


#### `create_modified_gaslib_network_plot.py`
Creates image of the modified GasLib40-3 network.
- Results:
    - Sec 1.6.4: Modified and non-modified network plots

## Data 

### Network physical data (`.net`)
These files store the elements of the networks (pipes and nodes) as well as additional information about each element. Nodes are distinguished by type as sources, sinks and inner nodes. Node data include: (x,y) coordinates, height, minimum and maximum pressures. Source data also include gas temperatures, which are used to create the algebraic solutions necessary for computing stationary solutions of the 1v model. Pipe data include: start and end nodes, length, diameter, and pipe roughness coefficient. 

The `.net` files for the simple networks:
- single pipe
- 3-star/Y-shape network
- A small network with a single cycle

are located in `network_data/optimization_data/network_files`.

The `.net` file for GasLib40-3 is located in `network_data/optimization_data/gaslib40`.

### Network solution data (`.lsf`)
The network solution data files store solutions to the Weymouth equation for a given network with a specification of certain boundary data.

The `.lsf` files for the simple networks are located in `network_data/optimization_data/solution_files`.

The `.lsf` file for GasLib40-3 is located in `network_data/optimization_data/gaslib40`.

**Note:** More general network structures and mixing scenarios are available as part of the repositories [TRR154/GasA01](https://github.com/TRR154/GasA01) and [TRR154/StationaryMixingData](https://github.com/TRR154/StationaryMixingData).

### Pressure law data 
This data consists of certain constants and coefficients required for defining the pressure laws, including the universal gas constant, the molar masses of methane and hydrogen, and coefficients for the virial and mixed virial expansions. The constants and coefficients are hard-coded in `pressure_law_comparisons.py`.







# Chapter sections with associated codes for results

## Section 1.3: Pressure laws
- Sec 1.3.2 (Comparison of pressure laws): 
    - `pressure_laws_comparison.py` 

## Section 1.5: One- and two-velocity mixtures on a single pipe
- Sec 1.5.3 (Computation of stationary solutions): 
    - `network_1v_timedep_dxdtform_massflowinflow.py` 
    - `network_2v_timedep_dxdtform_massflowinflow.py` 
    - `diff_1v_2v_one_pipe_massflowinflow.py`
    - `diff_1v_2v_one_pipe_pressureinflow.py`

- Sec 1.5.4 (Instationary solutions): 
    - `onepipe_instationary.py`

## Section 1.6: Mixtures on networks
- Sec 1.6.4 (Comparison of pressure laws on networks): 
    - `create_modified_gaslib_network_plot.py`
    - `network_1v_images.py`
- Sec 1.6.5 (Validation of optimisation results): 
    - `network_1v_timedep_dxdtform_massflowinflow.py` 
    - `network_1v_images.py`
- Sec 1.6.6 (Consistency of coupling for one- and two-velocity models):
    - `network_1v_timedep_dxdtform_massflowinflow.py` 
    - `network_2v_timedep_dxdtform_massflowinflow.py` 
    - `network_1v_images.py`
    - `diff_1v_2v_network_massflowinflow.py`
    - `diff_1v_2v_network_pressureinflow.py`
- Sec 1.6.7 (Instationary flows on networks): 
    - `network_1v_timedep_dxdtform_massflowinflow.py` 
    - `network_2v_timedep_dxdtform_massflowinflow.py` 
    - `linearinterpolants.py`
